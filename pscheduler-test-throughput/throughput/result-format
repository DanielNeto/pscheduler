#!/usr/bin/python
#
# Format a result
#

import pscheduler
import sys
import validate
import throughput_utils

#constants
SCHEMA_FILE = "pscheduler-schema-throughput-response.json"
logger      = pscheduler.Log(prefix="test-throughput")

try:
   format = sys.argv[1]
except IndexError:
   format = 'text/plain'

#load JSON
test_spec_json = pscheduler.json_load(exit_on_error=True)
logger.debug(test_spec_json)

# Validate output against schema
valid, message = validate.result_is_valid(test_spec_json)

if not valid:
   pscheduler.fail(message)

logger.debug("jsonschema passed for test result")

output = "Throughput Results\n"

intervals = test_spec_json["intervals"]
intervals.sort(key=lambda x: x["summary"]["start"])

# We're going to convert from interval view to stream view to keep
# all the same data together
stream_blocks = {}

for interval in intervals:
   streams = interval["streams"]
   summary = interval["summary"]
   start   = summary["start"]
   end     = summary["end"]

   # Make sure we get them in stream id order each time
   streams.sort(key=lambda x:  x["stream-id"])

   for stream in streams:
      stream_block = stream_blocks.get(stream["stream-id"], [])      
      stream_block.append(stream)
      stream_blocks[stream["stream-id"]] = stream_block


stream_ids = stream_blocks.keys()
stream_ids.sort()

# Don't show the per stream info if we only have the one, kind
# of pointless
for stream_id in stream_ids:
   output += "* Stream ID %s\n" % stream_id
   output += throughput_utils.format_stream_output(stream_blocks[stream_id])   
   output += "\n"

summary = test_spec_json["summary"]
summary_streams = summary["streams"]
summary_summary = summary["summary"]

summary_streams.sort(key=lambda x: x["stream-id"])

# Same reasoning as above, don't bother to show summary for a single
# thing
if len(summary_streams) > 1:
   for stream in summary_streams:
      output += "* Stream ID %s Summary\n" % stream['stream-id']
      output += throughput_utils.format_stream_output([stream])
      output += "\n"

output += "Summary\n"
output += throughput_utils.format_stream_output([summary_summary])

output += "\n"

if test_spec_json.get('mss-size'):
   output += "MSS: %s bytes\n" % (test_spec_json['mss-size'])
if test_spec_json.get('mtu'):
   output += "MTU: %s bytes\n" % (test_spec_json['mtu'])
if test_spec_json.get('tcp-window-size'):
   output += "TCP Window Size: %sbytes" % (throughput_utils.format_si(test_spec_json['tcp-window-size']))

   if test_spec_json.get('requested-tcp-window-size'):
      output += "  Requested: %sbytes" % (throughput_utils.format_si(test_spec_json['requested-tcp-window-size']))
   output += "\n"



#output += "\n\nDiag....\n"
#output += test_spec_json['diag']

print output
