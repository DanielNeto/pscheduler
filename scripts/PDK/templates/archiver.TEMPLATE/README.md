## Creating and Understanding a pScheduler Archiver

### 1. Understanding pScheduler Archivers
Before writing an archiver, it's important to understand how archivers are used in pScheduler as well as the perfSONAR 
best practices for developers. The wiki (https://github.com/perfsonar/project/wiki) contains help on how to develop for perfSONAR
in general. Examples of archivers can be found in the pScheduler source code (anything with archiver in the folder name in the 
main directory is an archiver).

### 2. Running the PDK setup script
Once you understand what you want to accomplish with your archiver, you'll want to make sure you have a pScheduler development 
environment set up on your development machine. The instructions for how to do this can be found on the general README page for 
the pScheduler repository. Then, you'll want to run the plugin_dev script as specified in the PDK README. This script will set 
up all of the files you need for your archiver and fill in the boilerplate code needed for a basic perfSONAR archiver. You
may also want to run the make commands indicated in the PDK README to make sure that everything is ready to go out of the box.

### 3. Developing your archiver
After the files are generated, you're ready to begin developing! Below we have a more thorough explanation of all of the files 
and directories generated by the plugin_dev script, which may be helpful to read through before you begin writing code.

### 4. Testing your archiver
There are two main ways to test your archiver:

1. Testing with scheduled pScheduler tasks or

2. Testing with premade JSON files

It's important to utilize both means of testing in your development workflow. However, for debugging purposes, the second 
testing method is usually more useful in terms of output and is also much faster.

#### Method 1:

-Follow the pScheduler documentation on how to use an archiver (https://github.com/perfsonar/pscheduler/wiki/Archivers)

#### Method 2:

_This method is somewhat more involved to set up, but ultimately it will allow you to debug much easier. If you do not run 
your archiver in this way, you will **not** be able to see any print statements you generate in your archiver code. **This 
includes error messages!** Running your archiver in the regular scheduled test format is important to verify that it works 
in that manner because that is how it will be used "in the wild", however, it will "fail silently" when run that way which won't 
help you make progress in developing it._

1. Obtain output JSON

-The easiest way to do this is to use the syslog archiver provided by pScheduler (https://github.com/perfsonar/pscheduler/wiki/Archivers#syslog)
Run a pScheduler task of your choice (a good default choice is idle) and output to the syslog archiver. The syslog archiver 
will generate a JSON blob of output that you can then use with your archiver. To access the output from the syslog archiver 
type in 
```sudo less /var/log/messages``` and use ```<``` to go to the end of the file (where your output should be if you just ran
 the task). Then just go ahead and copy that JSON blob at the end and save it somewhere useful.
 
 2. Create basic JSON for your archiver
 
 -The JSON piped directly into the archiver has two main parts: the archiver input that is fed to every archiver and the output from the task. To create a JSON file with all the data your archiver needs, simply follow this template used by 
 pScheduler when it generates the JSON that is actually used by an archiver when used normally: https://github.com/perfsonar/pscheduler/blob/b1e76b88c0ec712b43b01bb51e47575f40e0d49c/pscheduler-server/pscheduler-server/daemons/archiver.raw#L588
 
 -Only insert the fields you actually need. ```archiver-data``` will be replaced with a JSON blob that contains the actual data fields your archiver is expecting to see as input. Everything else can be filled in from the output JSON blob generated 
 by the syslog archiver. Delete any fields that are unnecessary based on the task you ran.
 
 -Once you generate this JSON, I recommend using jq on the file to make sure it's a valid JSON file. pScheduler will generate it's own specific error messages if the JSON is formatted in ways that it cannot accept. It's much easier to debug if you can deduce that errors you are getting are pScheduler specific and not just because your JSON is formatted incorrectly. If you have never used jq, you can find more documentation on how to use it here: https://stedolan.github.io/jq/ (You should not 
 need to install anything, your pScheduler development environment should come with jq already ready to use).
