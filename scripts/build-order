#!/bin/sh -e
#
# Preprocess the build order into something machine-usable
#
# Options:
#   --bundle b  Show packages in bundle b.  If b is "none," the output
#               will include only packages with no bundle specified.
#

WHEREAMI="$(dirname $0)"


# Gargle the arguments

BUNDLE=""

while echo "$1" | egrep -qe '^--.'
do
  OPTION="$1"
  shift

  case "$OPTION" in

      --bundle)
          BUNDLE="$1"
          shift
          ;;

      *)
          echo "Unknown option $OPTION" 1>&2
          exit 1
          ;;


  esac
done

bundle_filter()
{
    case "${BUNDLE}" in
	"")
	    cat
	    ;;
	none)
	    egrep -v -e '--bundle\s*[^\s]+'
	    ;;
	*)
	    fgrep -- "--bundle ${BUNDLE}"
	    ;;
    esac
}


. "${WHEREAMI}/os-info"


# Make arguments for M4, which is every set variable that begins with
# OSINFO_.
DEFINES=$(set \
    | sed -e '/^OSINFO_/!d; s/^OSINFO_\([^=]\+\)=\(.*\)$/-D '\''\1=\2'\''/' \
    | tr '\n' ' ')


# Process file file:
#  - Strip comments
#  - Run through M4
#  - Drop blank lines
#  - Filter bundles we want or don't want
#  - Grab package names only
sed -e 's/\s*#.*$//' "${WHEREAMI}/PACKAGE-BUILD-ORDER.m4" \
    | sh -c "m4 ${DEFINES}" \
    | sed -e '/^\s*$/d' \
    | bundle_filter \
    | awk '{ print $1 }'
