#!/usr/bin/python
#
# Format a result
#

import jsontemplate
import pscheduler
import sys

from validate import result_is_valid


try:
   format = sys.argv[1]
except IndexError:
   format = 'text/plain'

input = pscheduler.json_load(exit_on_error=True, max_schema=1)

valid, message = result_is_valid(input["result"])

if not valid:
    pscheduler.fail(message)

json = input["result"]


if format == 'text/plain':

   fail_template = "Test failed."

   template = """
Duration ... {.section duration}{duration}{.or}Not Reported{.end}
   """

elif format == 'text/html':

   fail_template = "<p>Test failed.</p>"

   template = """
<table border="0">

<tr><td><b>Duration</b></td><td>
{.section duration}{duration}{.or}<i>Not Reported</i>{.end}
</td></tr>
</table>
   """


elif format == 'application/x-pscheduler-json-simplified':

   # This doesn't use JSON templating, so dump the results and exit.

   try:
      if json["succeeded"]:
         print pscheduler.json_dump({
            "duration": pscheduler.iso8601_as_timedelta(json["duration"]).total_seconds()
         })
      else:
         pscheduler.fail("Run was not successful.")
   except Exception as ex:
      pscheduler.fail("Problem while generating PJS: %s" % (str(ex)))

   pscheduler.succeed()

else:

   pscheduler.fail("Unsupported format '%s'" % format)


# TODO: Should probably handle exceptions in a nicer way.
print jsontemplate.expand(
   template if json['succeeded'] else fail_template,
   json).strip()

pscheduler.succeed()
